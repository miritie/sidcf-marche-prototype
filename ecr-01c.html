<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fiche March√© - Module March√©s</title>
  
  <!-- CSS -->
  <link rel="stylesheet" href="../../assets/css/variables.css">
  <link rel="stylesheet" href="../../assets/css/base.css">
  <link rel="stylesheet" href="../../assets/css/components.css">
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="app-header">
      <div class="app-header-left">
        <a href="../../index.html" class="app-logo">
          <img src="../../assets/img/logo.png" alt="Logo SID-CF" id="appLogo">
          <div>
            <div class="app-logo-text">SID-CF</div>
            <span class="app-logo-subtitle">Module March√©s</span>
          </div>
        </a>
      </div>
      
      <div class="app-header-right">
        <div class="user-info">
          <div>
            <div class="user-name" id="userName">Jean KOUASSI</div>
            <div class="user-role" id="userRole">Administrateur</div>
          </div>
        </div>
      </div>
    </header>
    
    <!-- Navigation -->
    <nav class="app-nav">
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="../../index.html" class="nav-link">
            üìä Tableau de bord
          </a>
        </li>
        <li class="nav-item">
          <a href="ecr-01c.html" class="nav-link active">
            üìã March√©s
          </a>
        </li>
      </ul>
    </nav>
    
    <!-- Main Content -->
    <main class="app-main">
      <!-- Breadcrumb -->
      <div id="breadcrumbContainer"></div>
      
      <div class="flex justify-between align-center mb-lg">
        <h1 class="page-title mb-0" id="pageTitle">Fiche March√©</h1>
        <button class="btn btn-secondary" onclick="Navigation.goBack()">
          ‚Üê Retour
        </button>
      </div>
      
      <!-- Formulaire -->
      <form id="marcheForm" onsubmit="handleSubmit(event)">
        <!-- Identification du march√© -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">1. Identification du march√©</h2>
          </div>
          <div class="card-body">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">N¬∞ March√©</label>
                <input type="text" class="form-control" id="numeroMarche" readonly>
                <small class="form-text">G√©n√©r√© automatiquement</small>
              </div>
              
              <div class="form-group">
                <label class="form-label required">Exercice</label>
                <select class="form-control" id="exercice" required>
                  <option value="">S√©lectionner...</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label required">Intitul√© du march√©</label>
              <input type="text" class="form-control" id="intitule" required minlength="10">
              <small class="form-text">Minimum 10 caract√®res</small>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label required">Type de march√©</label>
                <select class="form-control" id="typeMarche" required>
                  <option value="">S√©lectionner...</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label required">Mode de passation</label>
                <select class="form-control" id="modePassation" required>
                  <option value="">S√©lectionner...</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label required">Unit√© op√©rationnelle</label>
                <select class="form-control" id="uniteOperationnelle" required>
                  <option value="">S√©lectionner...</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Cha√Æne budg√©taire -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">2. Cha√Æne budg√©taire</h2>
          </div>
          <div class="card-body">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label required">Section</label>
                <select class="form-control" id="section" required onchange="handleSectionChange()">
                  <option value="">S√©lectionner...</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label required">Programme</label>
                <select class="form-control" id="programme" required onchange="handleProgrammeChange()">
                  <option value="">S√©lectionner...</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label required">Activit√©</label>
                <select class="form-control" id="activite" required>
                  <option value="">S√©lectionner...</option>
                </select>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label required">Nature √©conomique</label>
                <select class="form-control" id="natureEconomique" required>
                  <option value="">S√©lectionner...</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label required">Bailleur</label>
                <select class="form-control" id="bailleur" required>
                  <option value="">S√©lectionner...</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Param√®tres pr√©visionnels -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">3. Param√®tres pr√©visionnels</h2>
          </div>
          <div class="card-body">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label required">Montant pr√©visionnel (FCFA)</label>
                <input type="number" class="form-control" id="montantPrevisionnel" required min="0" step="1">
              </div>
              
              <div class="form-group">
                <label class="form-label">Dur√©e pr√©visionnelle (jours)</label>
                <input type="number" class="form-control" id="dureePrev" min="1">
              </div>
              
              <div class="form-group">
                <label class="form-label">Date pr√©visionnelle de d√©marrage</label>
                <input type="date" class="form-control" id="datePrevueDemarrage">
              </div>
            </div>
          </div>
        </div>
        
        <!-- Livrables -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">4. Livrables</h2>
            <button type="button" class="btn btn-primary btn-sm" onclick="handleAjouterLivrable()">
              ‚ûï Ajouter un livrable
            </button>
          </div>
          <div class="card-body">
            <div id="livrablesContainer">
              <p class="text-center text-secondary">Aucun livrable ajout√©. Cliquez sur "Ajouter un livrable" pour commencer.</p>
            </div>
          </div>
        </div>
        
        <!-- Actions -->
        <div class="card-footer">
          <div class="btn-group">
            <button type="button" class="btn btn-secondary" onclick="Navigation.goBack()">
              Annuler
            </button>
            <button type="submit" class="btn btn-primary" id="submitBtn">
              üíæ Enregistrer
            </button>
          </div>
        </div>
      </form>
    </main>
  </div>
  
  <!-- Modal Livrable -->
  <div class="modal" id="livrableModal">
    <div class="modal-dialog">
      <div class="modal-header">
        <h3 class="modal-title" id="livrableModalTitle">Ajouter un livrable</h3>
        <button type="button" class="modal-close" onclick="closeLivrableModal()">√ó</button>
      </div>
      <div class="modal-body">
        <form id="livrableForm">
          <input type="hidden" id="livrableIndex">
          
          <div class="form-group">
            <label class="form-label required">Type de livrable</label>
            <select class="form-control" id="livrableType" required>
              <option value="">S√©lectionner...</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label required">Objet / Description</label>
            <textarea class="form-control" id="livrableObjet" required minlength="5" rows="3"></textarea>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label required">R√©gion</label>
              <select class="form-control" id="livrableRegion" required onchange="handleRegionChange()">
                <option value="">S√©lectionner...</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">D√©partement</label>
              <select class="form-control" id="livrableDepartement">
                <option value="">S√©lectionner...</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Commune</label>
              <input type="text" class="form-control" id="livrableCommune">
            </div>
            
            <div class="form-group">
              <label class="form-label">Village / Quartier</label>
              <input type="text" class="form-control" id="livrableVillage">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Latitude</label>
              <input type="number" class="form-control" id="livrableLatitude" step="0.0001" min="-90" max="90">
            </div>
            
            <div class="form-group">
              <label class="form-label">Longitude</label>
              <input type="number" class="form-control" id="livrableLongitude" step="0.0001" min="-180" max="180">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">B√©n√©ficiaire</label>
              <input type="text" class="form-control" id="livrableBeneficiaire">
            </div>
            
            <div class="form-group">
              <label class="form-label">Volume / Quantit√©</label>
              <input type="text" class="form-control" id="livrableVolume" placeholder="Ex: 5">
            </div>
            
            <div class="form-group">
              <label class="form-label">Unit√©</label>
              <input type="text" class="form-control" id="livrableUnite" placeholder="Ex: km, salle, unit√©">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeLivrableModal()">Annuler</button>
        <button type="button" class="btn btn-primary" onclick="saveLivrable()">Enregistrer</button>
      </div>
    </div>
  </div>
  
  <!-- Scripts -->
  <script src="../../assets/js/config.js"></script>
  <script src="../../assets/data/referentiels.js"></script>
  <script src="../../assets/data/mock-data.js"></script>
  <script src="../../assets/js/utils.js"></script>
  <script src="../../assets/js/data-layer.js"></script>
  <script src="../../assets/js/validation.js"></script>
  <script src="../../assets/js/navigation.js"></script>
  
  <script>
    // Variables globales
    let currentMarche = null;
    let currentMode = 'create'; // 'create', 'edit', 'view'
    let livrables = [];
    let editingLivrableIndex = -1;
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      // R√©cup√©rer les param√®tres de navigation
      const params = Navigation.getNavigationParams();
      
      if (params.marcheId) {
        currentMode = params.mode || 'view';
        loadMarche(params.marcheId);
      } else {
        currentMode = 'create';
        initNewMarche();
      }
      
      // Charger les r√©f√©rentiels
      loadReferentiels();
      
      // Breadcrumb
      document.getElementById('breadcrumbContainer').innerHTML = generateBreadcrumbHTML();
      
      // Logo
      configureLogo();
    });
    
    function configureLogo() {
      const logo = document.getElementById('appLogo');
      if (logo) {
        logo.src = '../../' + APP_CONFIG.logo.path;
        logo.onerror = function() {
          this.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><rect width="40" height="40" fill="%232d5f3f"/><text x="20" y="25" text-anchor="middle" fill="white" font-size="20" font-weight="bold">S</text></svg>';
        };
      }
    }
    
    // Charger les r√©f√©rentiels dans les select
    function loadReferentiels() {
      // Exercices
      populateSelect('exercice', REFERENTIELS.exercices);
      
      // Types de march√©s
      populateSelect('typeMarche', APP_CONFIG.typesMarch√©s);
      
      // Modes de passation
      const modesPassation = Object.entries(APP_CONFIG.rules.modesPassation).map(([code, config]) => ({
        code,
        label: config.label
      }));
      populateSelect('modePassation', modesPassation);
      
      // Unit√©s op√©rationnelles
      populateSelect('uniteOperationnelle', REFERENTIELS.unitesOperationnelles);
      
      // Sections
      populateSelect('section', REFERENTIELS.sections);
      
      // Natures √©conomiques
      populateSelect('natureEconomique', REFERENTIELS.naturesEconomiques);
      
      // Bailleurs
      populateSelect('bailleur', REFERENTIELS.bailleurs);
      
      // Types de livrables
      populateSelect('livrableType', APP_CONFIG.typesLivrables);
      
      // R√©gions
      populateSelect('livrableRegion', REFERENTIELS.regions);
    }
    
    function populateSelect(selectId, items) {
      const select = document.getElementById(selectId);
      if (!select) return;
      
      // Garder la premi√®re option (placeholder)
      const firstOption = select.options[0];
      select.innerHTML = '';
      if (firstOption) {
        select.appendChild(firstOption);
      }
      
      items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.code;
        option.textContent = item.label;
        select.appendChild(option);
      });
    }
    
    // Charger un march√© existant
    async function loadMarche(id) {
      const result = await dataLayer.get('marches', id);
      
      if (!result.success || !result.data) {
        Utils.showError('March√© non trouv√©');
        Navigation.goBack();
        return;
      }
      
      currentMarche = result.data;
      livrables = currentMarche.livrables || [];
      
      // Remplir le formulaire
      fillForm(currentMarche);
      
      // Afficher les livrables
      displayLivrables();
      
      // Titre de la page
      const title = currentMode === 'view' ? 'Consultation march√©' : 'Modification march√©';
      document.getElementById('pageTitle').textContent = `${title} - ${currentMarche.numeroMarche}`;
      
      // D√©sactiver le formulaire en mode consultation
      if (currentMode === 'view') {
        disableForm();
      }
    }
    
    // Initialiser un nouveau march√©
    function initNewMarche() {
      document.getElementById('pageTitle').textContent = 'Nouveau march√©';
      
      // Pr√©-remplir avec des valeurs par d√©faut
      document.getElementById('exercice').value = new Date().getFullYear().toString();
      document.getElementById('numeroMarche').value = '(√Ä g√©n√©rer)';
      
      // Pr√©-s√©lectionner l'utilisateur courant
      if (MOCK_DATA.currentUser) {
        document.getElementById('uniteOperationnelle').value = MOCK_DATA.currentUser.uniteOperationnelle;
      }
    }
    
    // Remplir le formulaire
    function fillForm(marche) {
      document.getElementById('numeroMarche').value = marche.numeroMarche || '';
      document.getElementById('exercice').value = marche.exercice || '';
      document.getElementById('intitule').value = marche.intitule || '';
      document.getElementById('typeMarche').value = marche.typeMarche || '';
      document.getElementById('modePassation').value = marche.modePassation || '';
      document.getElementById('uniteOperationnelle').value = marche.uniteOperationnelle || '';
      
      document.getElementById('section').value = marche.section || '';
      handleSectionChange(); // Pour charger les programmes
      document.getElementById('programme').value = marche.programme || '';
      handleProgrammeChange(); // Pour charger les activit√©s
      document.getElementById('activite').value = marche.activite || '';
      document.getElementById('natureEconomique').value = marche.natureEconomique || '';
      document.getElementById('bailleur').value = marche.bailleur || '';
      
      document.getElementById('montantPrevisionnel').value = marche.montantPrevisionnel || '';
      document.getElementById('dureePrev').value = marche.dureePrevue || '';
      document.getElementById('datePrevueDemarrage').value = marche.datePrevueDemarrage || '';
    }
    
    // D√©sactiver le formulaire (mode consultation)
    function disableForm() {
      const form = document.getElementById('marcheForm');
      const inputs = form.querySelectorAll('input, select, textarea, button');
      inputs.forEach(input => {
        if (input.id !== 'submitBtn') {
          input.disabled = true;
        }
      });
      
      document.getElementById('submitBtn').style.display = 'none';
    }
    
    // Gestion de la cha√Æne budg√©taire
    function handleSectionChange() {
      const sectionCode = document.getElementById('section').value;
      const programmes = ReferentielUtils.getProgrammesBySection(sectionCode);
      populateSelect('programme', programmes);
      
      // R√©initialiser activit√©
      document.getElementById('activite').innerHTML = '<option value="">S√©lectionner...</option>';
    }
    
    function handleProgrammeChange() {
      const programmeCode = document.getElementById('programme').value;
      const activites = ReferentielUtils.getActivitesByProgramme(programmeCode);
      populateSelect('activite', activites);
    }
    
    // === GESTION DES LIVRABLES ===
    
    function handleAjouterLivrable() {
      editingLivrableIndex = -1;
      document.getElementById('livrableModalTitle').textContent = 'Ajouter un livrable';
      document.getElementById('livrableForm').reset();
      document.getElementById('livrableModal').classList.add('show');
    }
    
    function handleModifierLivrable(index) {
      editingLivrableIndex = index;
      const livrable = livrables[index];
      
      document.getElementById('livrableModalTitle').textContent = 'Modifier le livrable';
      document.getElementById('livrableType').value = livrable.type || '';
      document.getElementById('livrableObjet').value = livrable.objet || '';
      document.getElementById('livrableRegion').value = livrable.localite?.region || '';
      handleRegionChange();
      document.getElementById('livrableDepartement').value = livrable.localite?.departement || '';
      document.getElementById('livrableCommune').value = livrable.localite?.commune || '';
      document.getElementById('livrableVillage').value = livrable.localite?.village || '';
      document.getElementById('livrableLatitude').value = livrable.coordonnees?.latitude || '';
      document.getElementById('livrableLongitude').value = livrable.coordonnees?.longitude || '';
      document.getElementById('livrableBeneficiaire').value = livrable.beneficiaire || '';
      document.getElementById('livrableVolume').value = livrable.volume || '';
      document.getElementById('livrableUnite').value = livrable.unite || '';
      
      document.getElementById('livrableModal').classList.add('show');
    }
    
    function handleSupprimerLivrable(index) {
      if (confirm('√ätes-vous s√ªr de vouloir supprimer ce livrable ?')) {
        livrables.splice(index, 1);
        displayLivrables();
        Utils.showSuccess('Livrable supprim√©');
      }
    }
    
    function handleRegionChange() {
      const regionCode = document.getElementById('livrableRegion').value;
      const departements = ReferentielUtils.getDepartementsByRegion(regionCode);
      populateSelect('livrableDepartement', departements);
    }
    
    function closeLivrableModal() {
      document.getElementById('livrableModal').classList.remove('show');
      document.getElementById('livrableForm').reset();
    }
    
    function saveLivrable() {
      const form = document.getElementById('livrableForm');
      
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      const livrable = {
        id: editingLivrableIndex >= 0 ? livrables[editingLivrableIndex].id : Utils.generateId('LIV'),
        type: document.getElementById('livrableType').value,
        objet: document.getElementById('livrableObjet').value,
        localite: {
          region: document.getElementById('livrableRegion').value,
          departement: document.getElementById('livrableDepartement').value,
          commune: document.getElementById('livrableCommune').value,
          village: document.getElementById('livrableVillage').value
        },
        coordonnees: {
          latitude: parseFloat(document.getElementById('livrableLatitude').value) || null,
          longitude: parseFloat(document.getElementById('livrableLongitude').value) || null
        },
        beneficiaire: document.getElementById('livrableBeneficiaire').value,
        volume: document.getElementById('livrableVolume').value,
        unite: document.getElementById('livrableUnite').value
      };
      
      if (editingLivrableIndex >= 0) {
        livrables[editingLivrableIndex] = livrable;
        Utils.showSuccess('Livrable modifi√©');
      } else {
        livrables.push(livrable);
        Utils.showSuccess('Livrable ajout√©');
      }
      
      displayLivrables();
      closeLivrableModal();
    }
    
    function displayLivrables() {
      const container = document.getElementById('livrablesContainer');
      
      if (livrables.length === 0) {
        container.innerHTML = '<p class="text-center text-secondary">Aucun livrable ajout√©. Cliquez sur "Ajouter un livrable" pour commencer.</p>';
        return;
      }
      
      container.innerHTML = `
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Type</th>
                <th>Objet</th>
                <th>Localisation</th>
                <th>B√©n√©ficiaire</th>
                <th>Volume</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${livrables.map((liv, index) => `
                <tr>
                  <td>
                    <span class="badge badge-secondary">${ReferentielUtils.getLabel('typesLivrables', liv.type)}</span>
                  </td>
                  <td>${liv.objet}</td>
                  <td>
                    ${ReferentielUtils.getLabel('regions', liv.localite?.region)}<br>
                    <small class="text-secondary">${liv.localite?.commune || '-'}</small>
                  </td>
                  <td>${liv.beneficiaire || '-'}</td>
                  <td>${liv.volume ? `${liv.volume} ${liv.unite || ''}` : '-'}</td>
                  <td>
                    <div class="btn-group">
                      <button type="button" class="btn btn-secondary btn-sm" onclick="handleModifierLivrable(${index})" title="Modifier">
                        ‚úèÔ∏è
                      </button>
                      <button type="button" class="btn btn-danger btn-sm" onclick="handleSupprimerLivrable(${index})" title="Supprimer">
                        üóëÔ∏è
                      </button>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
    
    // Soumission du formulaire
    async function handleSubmit(event) {
      event.preventDefault();
      
      const form = document.getElementById('marcheForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      // Collecter les donn√©es
      const data = {
        id: currentMarche?.id || Utils.generateId('MAR'),
        numeroMarche: currentMarche?.numeroMarche || Utils.generateNumeroMarche(
          document.getElementById('exercice').value,
          (await dataLayer.get('marches')).data.length + 1
        ),
        intitule: document.getElementById('intitule').value,
        typeMarche: document.getElementById('typeMarche').value,
        modePassation: document.getElementById('modePassation').value,
        categorie: document.getElementById('modePassation').value,
        uniteOperationnelle: document.getElementById('uniteOperationnelle').value,
        exercice: document.getElementById('exercice').value,
        section: document.getElementById('section').value,
        programme: document.getElementById('programme').value,
        activite: document.getElementById('activite').value,
        natureEconomique: document.getElementById('natureEconomique').value,
        bailleur: document.getElementById('bailleur').value,
        montantPrevisionnel: parseFloat(document.getElementById('montantPrevisionnel').value),
        dureePrevue: parseInt(document.getElementById('dureePrev').value) || null,
        datePrevueDemarrage: document.getElementById('datePrevueDemarrage').value || null,
        livrables: livrables,
        statut: currentMarche?.statut || 'PLANIFIE',
        priorite: currentMarche?.priorite || 'MOYENNE',
        devise: 'FCFA'
      };
      
      // Validation m√©tier
      const validation = ValidationRules.validateFicheMarche(data);
      
      if (!validation.valid) {
        const errorMsg = validation.errors.map(e => e.message).join('\n');
        Utils.showError(errorMsg);
        return;
      }
      
      // Sauvegarder
      let result;
      if (currentMode === 'edit') {
        result = await dataLayer.update('marches', data.id, data);
      } else {
        result = await dataLayer.save('marches', data);
      }
      
      if (result.success) {
        Utils.showSuccess(APP_CONFIG.messages.saveSuccess);
        setTimeout(() => {
          Navigation.navigateTo('../../index.html');
        }, 1000);
      } else {
        Utils.showError(APP_CONFIG.messages.saveError);
      }
    }
  </script>
</body>
</html>
