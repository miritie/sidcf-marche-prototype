<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Module March√©s - SID-CF</title>
  
  <!-- CSS -->
  <link rel="stylesheet" href="./assets/css/variables.css">
  <link rel="stylesheet" href="./assets/css/base.css">
  <link rel="stylesheet" href="./assets/css/components.css">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="./assets/img/logo.png">
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="app-header">
      <div class="app-header-left">
        <a href="index.html" class="app-logo">
          <img src="./assets/img/logo.png" alt="Logo SID-CF" id="appLogo">
          <div>
            <div class="app-logo-text">SID-CF</div>
            <span class="app-logo-subtitle">Module March√©s</span>
          </div>
        </a>
      </div>
      
      <div class="app-header-right">
        <div class="user-info">
          <div>
            <div class="user-name" id="userName">Jean KOUASSI</div>
            <div class="user-role" id="userRole">Administrateur</div>
          </div>
        </div>
        <button class="btn btn-danger btn-sm" onclick="handleLogout()">
          D√©connexion
        </button>
      </div>
    </header>
    
    <!-- Navigation -->
    <nav class="app-nav">
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="index.html" class="nav-link active">
            üìä Tableau de bord
          </a>
        </li>
        <li class="nav-item">
          <a href="pages/planification/ecr-01c.html" class="nav-link">
            üìã March√©s
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" id="demandesLink">
            üì• Demandes d'achat
            <span class="badge">8</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link">
            üßæ Bons de commande
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" id="facturesLink">
            üìÑ Factures
            <span class="badge">0</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link">
            üí∞ Paiements
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link">
            üìÉ Contrats
          </a>
        </li>
        <li class="nav-item">
          <a href="pages/parametrage/index.html" class="nav-link">
            ‚öôÔ∏è Param√®tres
          </a>
        </li>
      </ul>
    </nav>
    
    <!-- Main Content -->
    <main class="app-main">
      <h1 class="page-title">Gestion des March√©s Publics</h1>
      
      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card warning">
          <div class="stat-label">En attente visa</div>
          <div class="stat-value" id="statEnAttente">-</div>
        </div>
        
        <div class="stat-card info">
          <div class="stat-label">En validation</div>
          <div class="stat-value" id="statEnValidation">-</div>
        </div>
        
        <div class="stat-card success">
          <div class="stat-label">Approuv√©s</div>
          <div class="stat-value" id="statApprouves">-</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-label">Montant total</div>
          <div class="stat-value" id="statMontantTotal">-</div>
        </div>
      </div>
      
      <!-- Filters & Actions -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Liste des March√©s</h2>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="handleNouveauMarche()">
              ‚ûï Nouveau march√©
            </button>
            <button class="btn btn-secondary" onclick="handleImportPPM()">
              üì• Importer PPM
            </button>
          </div>
        </div>
        
        <div class="card-body">
          <!-- Toolbar -->
          <div class="toolbar">
            <div class="toolbar-left">
              <div class="search-box">
                <span class="search-icon">üîç</span>
                <input 
                  type="text" 
                  class="form-control" 
                  id="searchInput" 
                  placeholder="Rechercher un march√©..."
                  onkeyup="handleSearch()"
                >
              </div>
            </div>
            
            <div class="toolbar-right">
              <div class="filters">
                <select class="form-control" id="filterStatut" onchange="handleFilter()">
                  <option value="">Tous les statuts</option>
                  <option value="PLANIFIE">Planifi√©</option>
                  <option value="EN_PASSATION">En passation</option>
                  <option value="ATTENTE_VISA">Attente visa CF</option>
                  <option value="VISE">Vis√©</option>
                  <option value="RESERVE">R√©serv√©</option>
                  <option value="REFUSE">Refus√©</option>
                  <option value="EN_EXECUTION">En ex√©cution</option>
                  <option value="RESILIE">R√©sili√©</option>
                  <option value="CLOS">Clos</option>
                </select>
                
                <select class="form-control" id="filterExercice" onchange="handleFilter()">
                  <option value="">Tous les exercices</option>
                  <option value="2024" selected>2024</option>
                  <option value="2025">2025</option>
                </select>
                
                <select class="form-control" id="filterType" onchange="handleFilter()">
                  <option value="">Tous les types</option>
                  <option value="TRAVAUX">Travaux</option>
                  <option value="FOURNITURES">Fournitures</option>
                  <option value="SERVICES">Services</option>
                  <option value="PI">Prestations Intellectuelles</option>
                </select>
              </div>
              
              <button class="btn btn-secondary btn-sm" onclick="handleExport()">
                üìä Exporter
              </button>
            </div>
          </div>
          
          <!-- Table -->
          <div class="table-container">
            <table class="table" id="marchesTable">
              <thead>
                <tr>
                  <th>N¬∞ March√©</th>
                  <th>Intitul√©</th>
                  <th>Type</th>
                  <th>Mode</th>
                  <th>Montant</th>
                  <th>Statut</th>
                  <th>Priorit√©</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="marchesTableBody">
                <tr>
                  <td colspan="8" class="text-center">
                    <div class="loading">
                      <div class="spinner"></div>
                      <div>Chargement des donn√©es...</div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Pagination -->
          <div class="pagination" id="pagination"></div>
        </div>
      </div>
      
      <!-- Alertes et notifications -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üîî Alertes et notifications</h2>
        </div>
        <div class="card-body" id="alertesContainer">
          <p class="text-center text-secondary">Aucune alerte pour le moment</p>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Scripts -->
  <script src="./assets/js/config.js"></script>
  <script src="./assets/data/referentiels.js"></script>
  <script src="./assets/data/mock-data.js"></script>
  <script src="./assets/js/utils.js"></script>
  <script src="./assets/js/data-layer.js"></script>
  <script src="./assets/js/validation.js"></script>
  <script src="./assets/js/navigation.js"></script>
  
  <script>
    // Variables globales
    let currentFilters = {
      search: '',
      statut: '',
      exercice: '2024',
      type: ''
    };
    
    let currentPage = 1;
    const itemsPerPage = 10;
    
    // Initialisation au chargement de la page
    document.addEventListener('DOMContentLoaded', async () => {
      // Charger les donn√©es utilisateur
      loadUserInfo();
      
      // Charger les statistiques
      await loadStatistics();
      
      // Charger les march√©s
      await loadMarches();
      
      // Charger les alertes
      loadAlertes();
      
      // Configurer le logo
      configureLogo();
    });
    
    // Charger les infos utilisateur
    function loadUserInfo() {
      const user = MOCK_DATA.currentUser;
      document.getElementById('userName').textContent = `${user.prenoms} ${user.nom}`;
      document.getElementById('userRole').textContent = ReferentielUtils.getLabel('roles', user.role);
    }
    
    // Configurer le logo
    function configureLogo() {
      const logo = document.getElementById('appLogo');
      if (logo) {
        logo.src = APP_CONFIG.logo.path;
        logo.alt = APP_CONFIG.logo.alt;
        // Fallback si le logo n'existe pas
        logo.onerror = function() {
          this.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><rect width="40" height="40" fill="%232d5f3f"/><text x="20" y="25" text-anchor="middle" fill="white" font-size="20" font-weight="bold">S</text></svg>';
        };
      }
    }
    
    // Charger les statistiques
    async function loadStatistics() {
      const result = await dataLayer.getStatistics(currentFilters);
      
      if (result.success) {
        const stats = result.data;
        
        document.getElementById('statEnAttente').textContent = stats.parStatut.ATTENTE_VISA || 0;
        document.getElementById('statEnValidation').textContent = 
          (stats.parStatut.EN_PASSATION || 0) + (stats.parStatut.RESERVE || 0);
        document.getElementById('statApprouves').textContent = 
          (stats.parStatut.VISE || 0) + (stats.parStatut.EN_EXECUTION || 0) + (stats.parStatut.CLOS || 0);
        document.getElementById('statMontantTotal').textContent = 
          Utils.formatMontant(stats.montantTotal);
      }
    }
    
    // Charger les march√©s
    async function loadMarches() {
      const result = await dataLayer.search('marches', currentFilters);
      
      if (!result.success) {
        Utils.showError('Erreur lors du chargement des march√©s');
        return;
      }
      
      const marches = result.data;
      displayMarches(marches);
      updatePagination(marches.length);
    }
    
    // Afficher les march√©s dans le tableau
    function displayMarches(marches) {
      const tbody = document.getElementById('marchesTableBody');
      
      if (marches.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8">
              <div class="empty-state">
                <div class="empty-state-icon">üìã</div>
                <div class="empty-state-text">Aucun march√© trouv√©</div>
                <p>Essayez de modifier vos filtres ou cr√©ez un nouveau march√©</p>
              </div>
            </td>
          </tr>
        `;
        return;
      }
      
      // Pagination
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageMarches = marches.slice(start, end);
      
      tbody.innerHTML = pageMarches.map(marche => `
        <tr>
          <td>
            <strong>${marche.numeroMarche}</strong>
          </td>
          <td>
            <div style="max-width: 300px;">
              ${marche.intitule}
            </div>
            <small class="text-secondary">${ReferentielUtils.getLabel('unitesOperationnelles', marche.uniteOperationnelle)}</small>
          </td>
          <td>
            <span class="badge badge-secondary">${marche.typeMarche}</span>
          </td>
          <td>
            <span class="badge badge-info">${marche.modePassation}</span>
          </td>
          <td>
            ${Utils.formatMontant(marche.montantActuel || marche.montantInitial || marche.montantPrevisionnel)}
          </td>
          <td>
            <span class="badge ${Utils.getStatutClass(marche.statut)}">
              ${Utils.getStatutLabel(marche.statut)}
            </span>
          </td>
          <td>
            <span class="badge ${Utils.getPrioriteClass(marche.priorite)}">
              ${marche.priorite}
            </span>
          </td>
          <td>
            <div class="btn-group">
              <button class="btn btn-primary btn-sm" onclick="handleVoirMarche('${marche.id}')" title="Voir">
                üëÅÔ∏è
              </button>
              <button class="btn btn-secondary btn-sm" onclick="handleModifierMarche('${marche.id}')" title="Modifier">
                ‚úèÔ∏è
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }
    
    // Mise √† jour de la pagination
    function updatePagination(totalItems) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      const container = document.getElementById('pagination');
      
      if (totalPages <= 1) {
        container.innerHTML = '';
        return;
      }
      
      let html = `
        <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">
          ‚Äπ Pr√©c√©dent
        </button>
      `;
      
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          html += `
            <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">
              ${i}
            </button>
          `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += `<span class="pagination-btn" disabled>...</span>`;
        }
      }
      
      html += `
        <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">
          Suivant ‚Ä∫
        </button>
      `;
      
      container.innerHTML = html;
    }
    
    // Changer de page
    function changePage(page) {
      currentPage = page;
      loadMarches();
    }
    
    // G√©rer la recherche
    function handleSearch() {
      const searchValue = document.getElementById('searchInput').value;
      currentFilters.search = searchValue;
      currentPage = 1;
      loadMarches();
    }
    
    // G√©rer les filtres
    function handleFilter() {
      currentFilters.statut = document.getElementById('filterStatut').value;
      currentFilters.exercice = document.getElementById('filterExercice').value;
      currentFilters.type = document.getElementById('filterType').value;
      currentPage = 1;
      loadMarches();
      loadStatistics();
    }
    
    // Charger les alertes
    function loadAlertes() {
      const container = document.getElementById('alertesContainer');
      const marches = MOCK_DATA.marches;
      
      const alertes = [];
      
      marches.forEach(marche => {
        // V√©rifier les retards
        if (marche.statut === 'VISE' && !marche.ordreService) {
          const retard = Utils.checkRetard('OS_AFTER_VISA', { dateVisaCF: marche.dateVisaCF });
          if (retard) {
            alertes.push({
              type: 'warning',
              marche: marche.numeroMarche,
              message: retard.message
            });
          }
        }
        
        // V√©rifier les avenants
        if (marche.avenants && marche.avenants.length > 0) {
          const check = Utils.checkSeuilAvenant(marche.montantInitial, marche.avenants);
          if (check.depasseAlerte || check.depasseSeuil) {
            alertes.push({
              type: check.depasseSeuil ? 'danger' : 'warning',
              marche: marche.numeroMarche,
              message: check.message
            });
          }
        }
        
        // V√©rifier les recours
        if (marche.recours && marche.recours.enCours) {
          alertes.push({
            type: 'info',
            marche: marche.numeroMarche,
            message: `Recours ${marche.recours.type} en cours`
          });
        }
      });
      
      if (alertes.length === 0) {
        container.innerHTML = '<p class="text-center text-secondary">Aucune alerte pour le moment</p>';
        return;
      }
      
      container.innerHTML = alertes.map(alerte => `
        <div class="alert alert-${alerte.type}">
          <strong>${alerte.marche}</strong>: ${alerte.message}
        </div>
      `).join('');
    }
    
    // Actions
    function handleNouveauMarche() {
      Navigation.navigateTo('pages/planification/ecr-01b.html');
    }
    
    function handleImportPPM() {
      Navigation.navigateTo('pages/planification/ecr-01a.html');
    }
    
    function handleVoirMarche(id) {
      Navigation.navigateTo('pages/planification/ecr-01c.html', { marcheId: id, mode: 'view' });
    }
    
    function handleModifierMarche(id) {
      Navigation.navigateTo('pages/planification/ecr-01c.html', { marcheId: id, mode: 'edit' });
    }
    
    function handleExport() {
      dataLayer.search('marches', currentFilters).then(result => {
        if (result.success) {
          const exportData = result.data.map(m => ({
            'N¬∞ March√©': m.numeroMarche,
            'Intitul√©': m.intitule,
            'Type': m.typeMarche,
            'Mode': m.modePassation,
            'Montant': m.montantActuel || m.montantInitial || m.montantPrevisionnel,
            'Statut': Utils.getStatutLabel(m.statut),
            'Exercice': m.exercice,
            'Unit√©': ReferentielUtils.getLabel('unitesOperationnelles', m.uniteOperationnelle)
          }));
          
          Utils.exportToCSV(exportData, `marches_${new Date().toISOString().split('T')[0]}.csv`);
          Utils.showSuccess('Export r√©ussi');
        }
      });
    }
    
    function handleLogout() {
      if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
        // Redirection vers page de login (√† impl√©menter)
        window.location.href = 'index.html';
      }
    }
  </script>
</body>
</html>
