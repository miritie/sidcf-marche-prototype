<!-- Page March√©s - Gestion compl√®te des march√©s -->
<div class="page-header">
    <div class="breadcrumb">
        <a href="#" onclick="App.loadPage('dashboard')">Accueil</a>
        <span class="separator">/</span>
        <span>March√©s</span>
    </div>
    <div class="d-flex justify-content-between align-items-center">
        <h2>Gestion des March√©s</h2>
        <div class="d-flex gap-2">
            <button class="btn btn-secondary" onclick="App.exportToCSV('marches')">
                <span>üì•</span> Exporter
            </button>
            <button class="btn btn-primary" onclick="openMarcheModal()">
                <span>‚ûï</span> Nouveau March√©
            </button>
        </div>
    </div>
</div>

<!-- Filtres et recherche -->
<div class="card mb-3">
    <div class="card-body">
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 16px; align-items: end;">
            <div class="form-group">
                <label class="form-label">Rechercher</label>
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" 
                           placeholder="Code, intitul√©, fournisseur..." 
                           id="searchMarches"
                           onkeyup="filterMarches()">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Type</label>
                <select class="form-control" id="filterType" onchange="filterMarches()">
                    <option value="">Tous les types</option>
                    <option value="FOUR">Fournitures</option>
                    <option value="TRAV">Travaux</option>
                    <option value="SERV">Services</option>
                    <option value="PREST">Prestations</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Statut</label>
                <select class="form-control" id="filterStatut" onchange="filterMarches()">
                    <option value="">Tous les statuts</option>
                    <option value="Brouillon">Brouillon</option>
                    <option value="En validation">En validation</option>
                    <option value="Actif">Actif</option>
                    <option value="Suspendu">Suspendu</option>
                    <option value="R√©sili√©">R√©sili√©</option>
                    <option value="Cl√¥tur√©">Cl√¥tur√©</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Fournisseur</label>
                <select class="form-control" id="filterFournisseur" onchange="filterMarches()">
                    <option value="">Tous les fournisseurs</option>
                </select>
            </div>
            
            <button class="btn btn-outline" onclick="resetFilters()">
                <span>üîÑ</span> R√©initialiser
            </button>
        </div>
    </div>
</div>

<!-- Tableau des march√©s -->
<div class="card">
    <div class="card-body">
        <div class="table-container">
            <table class="data-table" id="marchesTable">
                <thead>
                    <tr>
                        <th onclick="sortTable('codeMarche')">Code ‚Üï</th>
                        <th onclick="sortTable('intitule')">Intitul√© ‚Üï</th>
                        <th onclick="sortTable('type')">Type ‚Üï</th>
                        <th onclick="sortTable('fournisseur')">Fournisseur ‚Üï</th>
                        <th onclick="sortTable('montantTTC')">Montant TTC ‚Üï</th>
                        <th onclick="sortTable('dateDebut')">Date D√©but ‚Üï</th>
                        <th onclick="sortTable('dateFin')">Date Fin ‚Üï</th>
                        <th>Taux Ex√©cution</th>
                        <th onclick="sortTable('statut')">Statut ‚Üï</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="marchesTableBody">
                    <!-- Sera rempli dynamiquement -->
                </tbody>
            </table>
        </div>
        
        <div class="pagination" id="marchesPagination">
            <!-- Pagination g√©n√©r√©e dynamiquement -->
        </div>
    </div>
</div>

<!-- Modal Cr√©ation/Edition March√© -->
<div class="modal" id="marcheModal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h3 class="modal-title" id="marcheModalTitle">Nouveau March√©</h3>
            <button class="modal-close" onclick="closeMarcheModal()">&times;</button>
        </div>
        
        <form id="marcheForm" onsubmit="saveMarche(event)">
            <div class="modal-body">
                <!-- Informations g√©n√©rales -->
                <h4 style="color: var(--primary-green); margin-bottom: 16px;">Informations g√©n√©rales</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">
                            Code March√© <span class="required">*</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="codeMarche" 
                               name="codeMarche" 
                               required 
                               pattern="M\d{4}-\d{3}"
                               placeholder="M2024-001">
                        <div class="form-text">Format: M + ann√©e + num√©ro (ex: M2024-001)</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            Type de march√© <span class="required">*</span>
                        </label>
                        <select class="form-control" 
                                id="typeMarche" 
                                name="type" 
                                required 
                                onchange="updateModePassation()">
                            <option value="">-- S√©lectionner --</option>
                            <option value="FOUR">Fournitures</option>
                            <option value="TRAV">Travaux</option>
                            <option value="SERV">Services</option>
                            <option value="PREST">Prestations intellectuelles</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="form-label">
                            Intitul√© du march√© <span class="required">*</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="intituleMarche" 
                               name="intitule" 
                               required 
                               minlength="10" 
                               maxlength="200"
                               placeholder="Ex: Fourniture d'√©quipements informatiques">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            Mode de passation <span class="required">*</span>
                        </label>
                        <select class="form-control" 
                                id="modePassation" 
                                name="modePassation" 
                                required>
                            <option value="">-- S√©lectionner --</option>
                            <option value="GRG">Gr√© √† gr√© (< 5M FCFA)</option>
                            <option value="DC">Demande de Cotation (< 20M FCFA)</option>
                            <option value="AOR">Appel d'Offres Restreint (< 50M FCFA)</option>
                            <option value="AOO">Appel d'Offres Ouvert (‚â• 50M FCFA)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            Fournisseur <span class="required">*</span>
                        </label>
                        <select class="form-control" 
                                id="fournisseurMarche" 
                                name="fournisseurId" 
                                required>
                            <option value="">-- S√©lectionner --</option>
                        </select>
                    </div>
                </div>
                
                <!-- Montants et dates -->
                <h4 style="color: var(--primary-green); margin: 24px 0 16px;">Montants et √©ch√©ances</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">
                            Montant HT (FCFA) <span class="required">*</span>
                        </label>
                        <input type="number" 
                               class="form-control" 
                               id="montantHT" 
                               name="montantHT" 
                               required 
                               min="100000" 
                               max="10000000000"
                               onchange="calculateTTC()">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">TVA (%)</label>
                        <input type="number" 
                               class="form-control" 
                               id="tva" 
                               name="tva" 
                               value="18" 
                               min="0" 
                               max="100"
                               onchange="calculateTTC()">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Montant TTC (FCFA)</label>
                        <input type="number" 
                               class="form-control" 
                               id="montantTTC" 
                               name="montantTTC" 
                               readonly 
                               style="background: var(--gray-100);">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            Date de d√©but <span class="required">*</span>
                        </label>
                        <input type="date" 
                               class="form-control" 
                               id="dateDebut" 
                               name="dateDebut" 
                               required
                               onchange="validateDates()">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            Date de fin <span class="required">*</span>
                        </label>
                        <input type="date" 
                               class="form-control" 
                               id="dateFin" 
                               name="dateFin" 
                               required
                               onchange="validateDates()">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Dur√©e (jours)</label>
                        <input type="number" 
                               class="form-control" 
                               id="duree" 
                               name="duree" 
                               readonly 
                               style="background: var(--gray-100);">
                    </div>
                </div>
                
                <!-- Description et justification -->
                <h4 style="color: var(--primary-green); margin: 24px 0 16px;">Description et justification</h4>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" 
                              id="description" 
                              name="description" 
                              rows="3" 
                              maxlength="2000"
                              placeholder="Description d√©taill√©e du march√©..."></textarea>
                    <div class="form-text">Maximum 2000 caract√®res</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Justification <span class="required">*</span>
                    </label>
                    <textarea class="form-control" 
                              id="justification" 
                              name="justification" 
                              rows="3" 
                              required 
                              minlength="50"
                              placeholder="Justification du besoin et de la proc√©dure..."></textarea>
                    <div class="form-text">Minimum 50 caract√®res</div>
                </div>
                
                <!-- Clauses particuli√®res -->
                <h4 style="color: var(--primary-green); margin: 24px 0 16px;">Clauses particuli√®res</h4>
                <div id="clausesContainer">
                    <div class="form-group">
                        <input type="text" 
                               class="form-control" 
                               placeholder="Ex: Garantie minimum 2 ans sur tout le mat√©riel">
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-secondary" onclick="addClause()">
                    <span>‚ûï</span> Ajouter une clause
                </button>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeMarcheModal()">Annuler</button>
                <button type="submit" class="btn btn-primary">
                    <span id="saveMarcheBtn">Enregistrer</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal D√©tails March√© -->
<div class="modal" id="marcheDetailsModal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h3 class="modal-title">D√©tails du March√©</h3>
            <button class="modal-close" onclick="closeMarcheDetailsModal()">&times;</button>
        </div>
        <div class="modal-body" id="marcheDetailsContent">
            <!-- Contenu g√©n√©r√© dynamiquement -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeMarcheDetailsModal()">Fermer</button>
            <button class="btn btn-secondary" onclick="printMarcheDetails()">
                <span>üñ®Ô∏è</span> Imprimer
            </button>
        </div>
    </div>
</div>

<script>
// Variables globales pour la page march√©s
let currentMarcheId = null;
let marchesFiltered = [];

// Initialisation de la page
function loadMarchesTable() {
    // Charger la liste des fournisseurs pour les filtres
    loadFournisseursSelect();
    
    // Appliquer les filtres et charger les donn√©es
    filterMarches();
}

// Chargement des fournisseurs
function loadFournisseursSelect() {
    const fournisseurs = db.tables.fournisseurs.filter(f => f.statut === 'Actif');
    
    // Pour le filtre
    const filterSelect = document.getElementById('filterFournisseur');
    if (filterSelect) {
        filterSelect.innerHTML = '<option value="">Tous les fournisseurs</option>';
        fournisseurs.forEach(f => {
            filterSelect.innerHTML += `<option value="${f.id}">${f.raisonSociale}</option>`;
        });
    }
    
    // Pour le formulaire
    const formSelect = document.getElementById('fournisseurMarche');
    if (formSelect) {
        formSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
        fournisseurs.forEach(f => {
            formSelect.innerHTML += `<option value="${f.id}">${f.raisonSociale}</option>`;
        });
    }
}

// Filtrage des march√©s
function filterMarches() {
    let marches = [...db.tables.marches];
    
    // Recherche textuelle
    const searchTerm = document.getElementById('searchMarches').value.toLowerCase();
    if (searchTerm) {
        marches = marches.filter(m => 
            m.codeMarche.toLowerCase().includes(searchTerm) ||
            m.intitule.toLowerCase().includes(searchTerm) ||
            m.fournisseur.toLowerCase().includes(searchTerm)
        );
    }
    
    // Filtre par type
    const filterType = document.getElementById('filterType').value;
    if (filterType) {
        marches = marches.filter(m => m.type === filterType);
    }
    
    // Filtre par statut
    const filterStatut = document.getElementById('filterStatut').value;
    if (filterStatut) {
        marches = marches.filter(m => m.statut === filterStatut);
    }
    
    // Filtre par fournisseur
    const filterFournisseur = document.getElementById('filterFournisseur').value;
    if (filterFournisseur) {
        marches = marches.filter(m => m.fournisseurId === filterFournisseur);
    }
    
    marchesFiltered = marches;
    displayMarches();
}

// Affichage des march√©s
function displayMarches(page = 1) {
    const perPage = 10;
    const start = (page - 1) * perPage;
    const end = start + perPage;
    const marchesToDisplay = marchesFiltered.slice(start, end);
    
    const tbody = document.getElementById('marchesTableBody');
    tbody.innerHTML = '';
    
    if (marchesToDisplay.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">Aucun march√© trouv√©</td></tr>';
        return;
    }
    
    marchesToDisplay.forEach(marche => {
        const typeInfo = CONFIG.typesMarche.find(t => t.code === marche.type);
        const statusClass = getStatusClass(marche.statut);
        const tauxExecution = marche.indicateursPerformance?.tauxExecution || 0;
        
        const row = `
            <tr>
                <td><strong>${marche.codeMarche}</strong></td>
                <td>${marche.intitule}</td>
                <td><span class="badge badge-primary">${typeInfo?.libelle || marche.type}</span></td>
                <td>${marche.fournisseur}</td>
                <td>${App.formatMoney(marche.montantTTC)}</td>
                <td>${App.formatDate(marche.dateDebut)}</td>
                <td>${App.formatDate(marche.dateFin)}</td>
                <td>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="flex: 1; height: 20px; background: var(--gray-200); border-radius: 10px; overflow: hidden;">
                            <div style="height: 100%; width: ${tauxExecution}%; background: ${tauxExecution > 75 ? 'var(--success)' : tauxExecution > 50 ? 'var(--warning)' : 'var(--info)'}"></div>
                        </div>
                        <span>${tauxExecution}%</span>
                    </div>
                </td>
                <td><span class="badge ${statusClass}">${marche.statut}</span></td>
                <td>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-info" onclick="viewMarche('${marche.id}')" title="Voir">
                            üëÅÔ∏è
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="editMarche('${marche.id}')" title="Modifier">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteMarche('${marche.id}')" title="Supprimer">
                            üóëÔ∏è
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
    
    // Pagination
    updatePagination(page, Math.ceil(marchesFiltered.length / perPage));
}

// Mise √† jour de la pagination
function updatePagination(currentPage, totalPages) {
    const pagination = document.getElementById('marchesPagination');
    let html = '';
    
    if (totalPages > 1) {
        html += `<button class="page-btn" onclick="displayMarches(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚Üê</button>`;
        
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="displayMarches(${i})">${i}</button>`;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                html += `<span style="padding: 0 8px;">...</span>`;
            }
        }
        
        html += `<button class="page-btn" onclick="displayMarches(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>‚Üí</button>`;
    }
    
    pagination.innerHTML = html;
}

// Tri des colonnes
function sortTable(field) {
    marchesFiltered.sort((a, b) => {
        if (a[field] < b[field]) return -1;
        if (a[field] > b[field]) return 1;
        return 0;
    });
    displayMarches();
}

// R√©initialisation des filtres
function resetFilters() {
    document.getElementById('searchMarches').value = '';
    document.getElementById('filterType').value = '';
    document.getElementById('filterStatut').value = '';
    document.getElementById('filterFournisseur').value = '';
    filterMarches();
}

// Ouverture du modal
function openMarcheModal() {
    currentMarcheId = null;
    document.getElementById('marcheModalTitle').textContent = 'Nouveau March√©';
    document.getElementById('saveMarcheBtn').textContent = 'Enregistrer';
    document.getElementById('marcheForm').reset();
    
    // G√©n√©rer un nouveau code
    const year = new Date().getFullYear();
    const count = db.tables.marches.length + 1;
    document.getElementById('codeMarche').value = `M${year}-${String(count).padStart(3, '0')}`;
    
    document.getElementById('marcheModal').classList.add('active');
}

// Fermeture du modal
function closeMarcheModal() {
    document.getElementById('marcheModal').classList.remove('active');
    currentMarcheId = null;
}

// Edition d'un march√©
function editMarche(id) {
    const marche = db.tables.marches.find(m => m.id === id);
    if (!marche) return;
    
    currentMarcheId = id;
    document.getElementById('marcheModalTitle').textContent = 'Modifier le March√©';
    document.getElementById('saveMarcheBtn').textContent = 'Mettre √† jour';
    
    // Remplir le formulaire
    document.getElementById('codeMarche').value = marche.codeMarche;
    document.getElementById('typeMarche').value = marche.type;
    document.getElementById('intituleMarche').value = marche.intitule;
    document.getElementById('modePassation').value = marche.modePassation;
    document.getElementById('fournisseurMarche').value = marche.fournisseurId;
    document.getElementById('montantHT').value = marche.montantHT;
    document.getElementById('tva').value = marche.montantTVA ? Math.round(marche.montantTVA / marche.montantHT * 100) : 18;
    document.getElementById('montantTTC').value = marche.montantTTC;
    document.getElementById('dateDebut').value = marche.dateDebut;
    document.getElementById('dateFin').value = marche.dateFin;
    document.getElementById('duree').value = marche.duree;
    document.getElementById('description').value = marche.description || '';
    document.getElementById('justification').value = marche.justification || '';
    
    document.getElementById('marcheModal').classList.add('active');
}

// Sauvegarde du march√©
function saveMarche(event) {
    event.preventDefault();
    
    if (!App.validateForm('marcheForm')) {
        return;
    }
    
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    
    // R√©cup√©rer le nom du fournisseur
    const fournisseur = db.tables.fournisseurs.find(f => f.id === data.fournisseurId);
    data.fournisseur = fournisseur ? fournisseur.raisonSociale : '';
    
    // Calculer la TVA
    data.montantTVA = data.montantHT * (data.tva / 100);
    data.montantTTC = parseFloat(data.montantHT) + data.montantTVA;
    
    try {
        if (currentMarcheId) {
            // Mise √† jour
            db.update('marches', currentMarcheId, data);
            App.showNotification('March√© mis √† jour avec succ√®s', 'success');
        } else {
            // Cr√©ation
            data.statut = 'Brouillon';
            data.creePar = window.AppState.currentUser?.id || 'USR001';
            data.indicateursPerformance = {
                tauxExecution: 0,
                montantConsomme: 0,
                nombreCommandes: 0
            };
            db.create('marches', data);
            App.showNotification('March√© cr√©√© avec succ√®s', 'success');
        }
        
        closeMarcheModal();
        filterMarches();
    } catch (error) {
        App.showNotification(error.message, 'error');
    }
}

// Suppression d'un march√©
function deleteMarche(id) {
    if (confirm('√ätes-vous s√ªr de vouloir supprimer ce march√© ?')) {
        try {
            db.delete('marches', id);
            App.showNotification('March√© supprim√© avec succ√®s', 'success');
            filterMarches();
        } catch (error) {
            App.showNotification(error.message, 'error');
        }
    }
}

// Visualisation d'un march√©
function viewMarche(id) {
    const marche = db.tables.marches.find(m => m.id === id);
    if (!marche) return;
    
    const typeInfo = CONFIG.typesMarche.find(t => t.code === marche.type);
    const modeInfo = CONFIG.modesPassation.find(m => m.code === marche.modePassation);
    const fournisseur = db.tables.fournisseurs.find(f => f.id === marche.fournisseurId);
    
    const content = `
        <div style="display: grid; gap: 24px;">
            <div>
                <h4 style="color: var(--primary-green); margin-bottom: 16px;">Informations g√©n√©rales</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <strong>Code March√©:</strong> ${marche.codeMarche}
                    </div>
                    <div>
                        <strong>Type:</strong> ${typeInfo?.libelle || marche.type}
                    </div>
                    <div style="grid-column: span 2;">
                        <strong>Intitul√©:</strong> ${marche.intitule}
                    </div>
                    <div>
                        <strong>Mode de passation:</strong> ${modeInfo?.libelle || marche.modePassation}
                    </div>
                    <div>
                        <strong>Statut:</strong> <span class="badge ${getStatusClass(marche.statut)}">${marche.statut}</span>
                    </div>
                </div>
            </div>
            
            <div>
                <h4 style="color: var(--primary-green); margin-bottom: 16px;">Fournisseur</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <strong>Raison sociale:</strong> ${fournisseur?.raisonSociale || marche.fournisseur}
                    </div>
                    <div>
                        <strong>IFU:</strong> ${fournisseur?.ifu || 'N/A'}
                    </div>
                    <div>
                        <strong>T√©l√©phone:</strong> ${fournisseur?.telephone || 'N/A'}
                    </div>
                    <div>
                        <strong>Email:</strong> ${fournisseur?.email || 'N/A'}
                    </div>
                </div>
            </div>
            
            <div>
                <h4 style="color: var(--primary-green); margin-bottom: 16px;">Montants et √©ch√©ances</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                    <div>
                        <strong>Montant HT:</strong> ${App.formatMoney(marche.montantHT)}
                    </div>
                    <div>
                        <strong>TVA:</strong> ${App.formatMoney(marche.montantTVA)}
                    </div>
                    <div>
                        <strong>Montant TTC:</strong> ${App.formatMoney(marche.montantTTC)}
                    </div>
                    <div>
                        <strong>Date d√©but:</strong> ${App.formatDate(marche.dateDebut)}
                    </div>
                    <div>
                        <strong>Date fin:</strong> ${App.formatDate(marche.dateFin)}
                    </div>
                    <div>
                        <strong>Dur√©e:</strong> ${marche.duree} jours
                    </div>
                </div>
            </div>
            
            ${marche.indicateursPerformance ? `
            <div>
                <h4 style="color: var(--primary-green); margin-bottom: 16px;">Indicateurs de performance</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                    <div>
                        <strong>Taux d'ex√©cution:</strong> ${marche.indicateursPerformance.tauxExecution}%
                    </div>
                    <div>
                        <strong>Montant consomm√©:</strong> ${App.formatMoney(marche.indicateursPerformance.montantConsomme)}
                    </div>
                    <div>
                        <strong>Nombre de commandes:</strong> ${marche.indicateursPerformance.nombreCommandes}
                    </div>
                </div>
            </div>
            ` : ''}
            
            ${marche.description ? `
            <div>
                <h4 style="color: var(--primary-green); margin-bottom: 16px;">Description</h4>
                <p>${marche.description}</p>
            </div>
            ` : ''}
            
            ${marche.justification ? `
            <div>
                <h4 style="color: var(--primary-green); margin-bottom: 16px;">Justification</h4>
                <p>${marche.justification}</p>
            </div>
            ` : ''}
        </div>
    `;
    
    document.getElementById('marcheDetailsContent').innerHTML = content;
    document.getElementById('marcheDetailsModal').classList.add('active');
}

// Fermeture du modal d√©tails
function closeMarcheDetailsModal() {
    document.getElementById('marcheDetailsModal').classList.remove('active');
}

// Impression des d√©tails
function printMarcheDetails() {
    window.print();
}

// Fonctions utilitaires
function getStatusClass(status) {
    switch(status) {
        case 'Actif': return 'badge-success';
        case 'Brouillon': return 'badge-info';
        case 'En validation': return 'badge-warning';
        case 'Suspendu': return 'badge-warning';
        case 'R√©sili√©': case 'Cl√¥tur√©': return 'badge-danger';
        default: return 'badge-secondary';
    }
}

function calculateTTC() {
    const montantHT = parseFloat(document.getElementById('montantHT').value) || 0;
    const tva = parseFloat(document.getElementById('tva').value) || 0;
    const montantTTC = montantHT + (montantHT * tva / 100);
    document.getElementById('montantTTC').value = Math.round(montantTTC);
}

function validateDates() {
    const dateDebut = new Date(document.getElementById('dateDebut').value);
    const dateFin = new Date(document.getElementById('dateFin').value);
    
    if (dateDebut && dateFin) {
        if (dateFin < dateDebut) {
            App.showNotification('La date de fin doit √™tre post√©rieure √† la date de d√©but', 'error');
            document.getElementById('dateFin').value = '';
            return;
        }
        
        const duree = Math.ceil((dateFin - dateDebut) / (1000 * 60 * 60 * 24));
        document.getElementById('duree').value = duree;
        
        if (duree < 7) {
            App.showNotification('La dur√©e minimale d\'un march√© est de 7 jours', 'warning');
        }
        if (duree > 1095) {
            App.showNotification('La dur√©e maximale d\'un march√© est de 3 ans (1095 jours)', 'warning');
        }
    }
}

function updateModePassation() {
    // Logique pour sugg√©rer le mode de passation selon le montant
    const montantHT = parseFloat(document.getElementById('montantHT').value) || 0;
    const modeSelect = document.getElementById('modePassation');
    
    if (montantHT < 5000000) {
        modeSelect.value = 'GRG';
    } else if (montantHT < 20000000) {
        modeSelect.value = 'DC';
    } else if (montantHT < 50000000) {
        modeSelect.value = 'AOR';
    } else {
        modeSelect.value = 'AOO';
    }
}

function addClause() {
    const container = document.getElementById('clausesContainer');
    const clauseDiv = document.createElement('div');
    clauseDiv.className = 'form-group';
    clauseDiv.innerHTML = `
        <div style="display: flex; gap: 8px;">
            <input type="text" class="form-control" placeholder="Nouvelle clause...">
            <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.parentElement.remove()">‚úñ</button>
        </div>
    `;
    container.appendChild(clauseDiv);
}
</script>